#!/bin/bash

CFG_DIR=~/.config/FFF
# xdg-open to use the default browser
BROWSER=xdg-open
# default yad width
YAD_WIDTH=800

check_config_dir () {
  # Check if configs are present, else create them
  if [ ! -d $CFG_DIR ] && [ -n "`ls -A $CFG_DIR` 2>/dev/null" ]
  then
    echo "Configuration directory does not exist."
    echo "Creating and populating it with default values."
    mkdir -p ~/.config/FFF
    cp -r config/FFF/* $CFG_DIR
  fi
}

get_categories () {
  # Create an array containing the search categories
  CATEGORIES=(`basename -s .cfg ~/.config/FFF/*.cfg`)
  echo ${CATEGORIES[@]}
}

get_tabs () {
  # Check how many new browser tabs each search category will open
  for (( i=0 ; i<${#CATEGORIES[@]} ; i++ ))
  do
    TAB=`grep SEARCH_ $CFG_DIR/${CATEGORIES[$i]}.cfg | wc -l`
    TABS+=($TAB)
  done 
}

create_yad_CHK () {
  # Iterate the search categories and format them to be used as arguments with yad
  #for i in {0..${#CATEGORIES[@]}}
  for (( i=0 ; i<${#CATEGORIES[@]} ; i++ ))
  do
    FIELD="${CATEGORIES[$i]} - ${TABS[$i]} tabs"
    YAD_CHK+=("\"--field=$FIELD:CHK\"")
  done
}

FFF () {
  # Store some yad options in a variable
  YAD_OPTIONS="--bool-fmt=1 \
    --title=FFF \
    --width=$YAD_WIDTH \
    --form \
    --field= \
    ${YAD_CHK[@]}"

  # Store yad command and some more options in a variable
  YAD_COMMAND="yad $YAD_OPTIONS --button=Search --buttons-layout=center"

  # Execute yad and store its output in an array
  IFS='|' ; YAD_OUTPUT=(`eval $YAD_COMMAND`)
  echo ${YAD_OUTPUT[0]} ${YAD_OUTPUT[@]}

  # Store the provided text field in an array
  IFS=';' && WORDS=(`echo "${YAD_OUTPUT[0]}"`)
  echo ${WORDS[1]}
  
  # Iterate the search entries
  for WORD in "${WORDS[@]}"
  do
    # substitute whitespace with:
    # plus sign + 
    WORD_PLUS=$(echo $WORD | sed 's/ /+/g')
    # minus sign -
    WORD_MINUS=$(echo $WORD | sed 's/ /-/g')
    # percent encoding %20
    WORD_PERC=$(echo $WORD | sed 's/ /%20/g')
  
    # Iterate the search categories
    for (( i=0 ; i<${#CATEGORIES[@]} ; i++ ))
    do
      if [ -z $WORD ]
      # Exit with no input provided
      then
        exit 
      # Check if search category checkbox was selected, if so apply the search
      else
        if [ ${YAD_OUTPUT[$i + 1]} = 1 ]
        then
          echo "Searching ${CATEGORIES[$i]}"
          source $CFG_DIR/${CATEGORIES[$i]}.cfg
          IFS=$'\n' ; for SEARCH_URL in `compgen -v | grep SEARCH_ $CFG_DIR/${CATEGORIES[$i]}.cfg | grep -v "#" | cut -d= -f2`
          do
            SEARCH="$BROWSER $SEARCH_URL"
            #echo $SEARCH
            eval $SEARCH
          done
          sleep 1
        fi
      fi
    done
  done
}

main () {
  check_config_dir
  get_categories
  get_tabs
  create_yad_CHK
  FFF
}

main
